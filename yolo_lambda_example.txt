
import urllib
import os
import subprocess
import boto3

BUCKET_NAME = 'hotsix-smartfarm'
ACCESS_KEY = 'AKIA5PJP5IRPYXVGWWWS'
SECRET_KEY = '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'
result=''
file_name=''


def lambda_handler(event, context):
    
    file_name = event['imgName']
    
    imgfilepath = '/tmp/'+file_name
    strWeightFile = '/tmp/yolov3.weights'
    
    downloadFromS3(BUCKET_NAME, 'image/'+file_name, imgfilepath)
    downloadFromS3(BUCKET_NAME, 'yolo/yolov3.weights', strWeightFile)
    
    command = './darknet detect ./cfg/yolov3.cfg {} {}'.format(
            strWeightFile,
            imgfilepath
        )
    output = subprocess.check_output(command ,shell=True)
    
    result = output[output.find("seconds.")+8:]
    
    #TODO implement
    return {
        'statusCode': 200,
        'body': result
    }



def downloadFromS3(strBucket, s3_path, local_path):
    s3_client = boto3.client(
        's3',
        aws_access_key_id=ACCESS_KEY,
        aws_secret_access_key = SECRET_KEY,
    )
    
    s3_client.download_file(strBucket, s3_path, local_path)